name: "pick random reviewer"

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  pick-random-reviewer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: pick_reviewer
        id: pick_reviewer
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const members = ['yuna872', 'u0empty', 'shun1423'];
            const prActor = process.env.GITHUB_ACTOR;

            // PR ìƒì„±ìë¥¼ ì œì™¸í•œ ë¦¬ë·°ì–´ ëª©ë¡ ìƒì„±
            const availableReviewers = members.filter(
              (member) => member.toUpperCase() !== prActor?.toUpperCase()
            );

            // ëœë¤ìœ¼ë¡œ ë¦¬ë·°ì–´ ì„ ì •
            const randomReviewer = availableReviewers[
              Math.floor(Math.random() * availableReviewers.length) // ë°°ì—´ ê¸¸ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬´ì‘ìœ„ ì„ íƒ
            ];

            // `randomReviewer`ë¥¼ ì œì™¸í•œ ëª©ë¡ ìƒì„±
            const availableMergeMen = availableReviewers.filter(
              (member) => member.toUpperCase() !== randomReviewer?.toUpperCase()
            );

            // ëœë¤ìœ¼ë¡œ ë¨¸ì§€ ë‹´ë‹¹ì ì„ ì •
            const mergeMan = availableMergeMen[
              Math.floor(Math.random() * availableMergeMen.length) // ë°°ì—´ ê¸¸ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬´ì‘ìœ„ ì„ íƒ
            ];

            // ì½”ë©˜íŠ¸ ë©”ì‹œì§€ ìƒì„±
            const comment1 = `ğŸ‰ @${randomReviewer}ë‹˜ í•´ë‹¹ ì£¼ì œë¥¼ ë©´ì ‘stë¡œ ìš”ì•½í•´ì£¼ì„¸ìš” ğŸ™`;
            const comment2 = `ğŸ‰ @${mergeMan}ë‹˜ ${randomReviewer}ë‹˜ì˜ ìš”ì•½ì„ í™•ì¸í•˜ì‹œê³  mergeë¥¼ ë¶€íƒë“œë ¤ìš”! :)`;

            // ê²°ê³¼ ì¶œë ¥
            core.setOutput('comment1', comment1);
            core.setOutput('comment2', comment2);
            core.setOutput('reviewer', randomReviewer);
            core.setOutput('mergeMan', mergeMan);


      - name: add_pr_comment1
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: ${{ steps.pick_reviewer.outputs.comment1 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: add_pr_comment2
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: ${{ steps.pick_reviewer.outputs.comment2 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: assign_reviewer
        uses: madrapps/add-reviewers@v1
        with:
          reviewers: ${{ steps.pick_reviewer.outputs.reviewer }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: assign_mergeMan
        uses: madrapps/add-reviewers@v1
        with:
          reviewers: ${{ steps.pick_reviewer.outputs.mergeMan }}
          token: ${{ secrets.GITHUB_TOKEN }}
